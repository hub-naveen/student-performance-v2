{% extends "base.html" %}

{% block title %}Teacher Dashboard - EduPredict AI{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="welcome-header">
                <h1 class="gradient-text fw-bold">
                    <i class="fas fa-chalkboard-teacher me-3"></i>
                    Teacher Dashboard
                </h1>
                <p class="text-muted">Manage your class performance and student analytics</p>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-number">{{ total_students }}</div>
                <div class="stats-label">Total Students</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-number">{{ avg_score }}</div>
                <div class="stats-label">Average Score</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-number">{{ avg_attendance }}%</div>
                <div class="stats-label">Avg Attendance</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-number">{{ avg_study_hours }}</div>
                <div class="stats-label">Avg Study Hours</div>
            </div>
        </div>
    </div>

    <!-- Performance Charts -->
    <div class="row mb-4">
        <div class="col-lg-4">
            <div class="chart-container">
                <h6 class="mb-3">
                    <i class="fas fa-chart-pie me-2"></i>
                    Class Performance Distribution
                </h6>
                <div id="classPerformanceChart"></div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="chart-container">
                <h6 class="mb-3">
                    <i class="fas fa-chart-bar me-2"></i>
                    Attendance Distribution
                </h6>
                <div id="attendanceDistributionChart"></div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="chart-container">
                <h6 class="mb-3">
                    <i class="fas fa-chart-line me-2"></i>
                    School Type Analysis
                </h6>
                <div id="subjectAnalyticsChart"></div>
            </div>
        </div>
    </div>

    <!-- Student Management -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>
                        Student List ({{ total_students }} Students)
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light btn-sm" onclick="exportToCSV()">
                            <i class="fas fa-download me-2"></i>Export CSV
                        </button>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                            <i class="fas fa-plus me-2"></i>Add Student
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>Gender</th>
                                    <th>Age</th>
                                    <th>Attendance</th>
                                    <th>Previous Score</th>
                                    <th>Study Hours</th>
                                    <th>Performance</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in students %}
                                <tr data-student-id="{{ student.student_id }}">
                                    <td>
                                        <span class="badge bg-primary">{{ student.student_id }}</span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar me-2">
                                                <i class="fas fa-user-circle fa-lg text-muted"></i>
                                            </div>
                                            <div>
                                                <div class="fw-bold">{{ student.Full_Name if student.Full_Name else student.Gender + ' Student' }}</div>
                                                <small class="text-muted">{{ student.School_Type }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'info' if student.Gender == 'Male' else 'warning' }}">
                                            {{ student.Gender }}
                                        </span>
                                    </td>
                                    <td>{{ student.age if student.age else 'N/A' }}</td>
                                    <td>
                                        <div class="attendance-bar">
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar bg-{{ 'success' if student.Attendance >= 85 else 'warning' if student.Attendance >= 70 else 'danger' }}" 
                                                     style="width: {{ student.Attendance }}%"></div>
                                            </div>
                                            <small class="text-muted">{{ student.Attendance }}%</small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if student.Previous_Scores >= 80 else 'warning' if student.Previous_Scores >= 60 else 'danger' }}">
                                            {{ student.Previous_Scores }}
                                        </span>
                                    </td>
                                    <td>{{ student.Hours_Studied }}h</td>
                                    <td>
                                        {% set performance = 'High' if student.Previous_Scores >= 80 else 'Medium' if student.Previous_Scores >= 60 else 'Low' %}
                                        <span class="badge bg-{{ 'success' if performance == 'High' else 'warning' if performance == 'Medium' else 'danger' }}">
                                            {{ performance }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="viewStudent('{{ student.student_id }}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-warning" onclick="editStudent('{{ student.student_id }}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-info" onclick="generateReport('{{ student.student_id }}')">
                                                <i class="fas fa-file-alt"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination Info and Controls -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="d-flex align-items-center gap-3">
                            <div class="text-muted">
                                Showing {{ start_idx }}-{{ end_idx }} of {{ total_students }} students
                            </div>
                            
                            <!-- Page Size Selector -->
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0 text-muted small">Show:</label>
                                <select class="form-select form-select-sm" id="pageSizeSelect" onchange="changePageSize()" style="width: 80px;">
                                    <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                                    <option value="15" {% if per_page == 15 %}selected{% endif %}>15</option>
                                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                                </select>
                                <span class="text-muted small">per page</span>
                            </div>
                            
                            {% if total_pages > 1 %}
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0 text-muted small">Go to page:</label>
                                <input type="number" class="form-control form-control-sm" 
                                       id="pageJumpInput" min="1" max="{{ total_pages }}" 
                                       style="width: 70px;" placeholder="{{ current_page }}">
                                <button class="btn btn-outline-primary btn-sm" onclick="goToPage()">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        
                        {% if total_pages > 1 %}
                        <nav aria-label="Student list pagination">
                            <ul class="pagination pagination-sm mb-0">
                                <!-- Previous button -->
                                {% if current_page > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('teacher_dashboard', page=current_page-1, per_page=per_page) }}">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                </li>
                                {% endif %}
                                
                                <!-- Page numbers -->
                                {% set start_page = [1, current_page - 2] | max %}
                                {% set end_page = [total_pages, current_page + 2] | min %}
                                
                                {% if start_page > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('teacher_dashboard', page=1, per_page=per_page) }}">1</a>
                                </li>
                                {% if start_page > 2 %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %}
                                {% endif %}
                                
                                {% for page_num in range(start_page, end_page + 1) %}
                                <li class="page-item {% if page_num == current_page %}active{% endif %}">
                                    <a class="page-link" href="{{ url_for('teacher_dashboard', page=page_num, per_page=per_page) }}">{{ page_num }}</a>
                                </li>
                                {% endfor %}
                                
                                {% if end_page < total_pages %}
                                {% if end_page < total_pages - 1 %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('teacher_dashboard', page=total_pages, per_page=per_page) }}">{{ total_pages }}</a>
                                </li>
                                {% endif %}
                                
                                <!-- Next button -->
                                {% if current_page < total_pages %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('teacher_dashboard', page=current_page+1, per_page=per_page) }}">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Insights -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Performance Insights
                    </h5>
                </div>
                <div class="card-body">
                    <div class="insights">
                        <div class="insight-item">
                            <i class="fas fa-star text-warning me-2"></i>
                            <span><strong>{{ students|selectattr('Previous_Scores', '>=', 80)|list|length }}</strong> students are performing excellently (80+ scores)</span>
                        </div>
                        
                        <div class="insight-item">
                            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                            <span><strong>{{ students|selectattr('Previous_Scores', '<', 60)|list|length }}</strong> students need immediate attention (below 60)</span>
                        </div>
                        
                        <div class="insight-item">
                            <i class="fas fa-chart-line text-info me-2"></i>
                            <span>Class average attendance is <strong>{{ avg_attendance }}%</strong></span>
                        </div>
                        
                        {% if avg_attendance < 80 %}
                        <div class="insight-item alert alert-warning">
                            <i class="fas fa-bell text-warning me-2"></i>
                            <span>Class attendance is below recommended levels. Consider intervention strategies.</span>
                        </div>
                        {% endif %}
                        
                        <div class="insight-item">
                            <i class="fas fa-clock text-primary me-2"></i>
                            <span>Average study time is <strong>{{ avg_study_hours }} hours</strong> per week</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bullhorn me-2"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="quick-actions">
                        <button class="btn btn-outline-primary w-100 mb-2" onclick="sendAnnouncement()">
                            <i class="fas fa-bullhorn me-2"></i>
                            Send Class Announcement
                        </button>
                        
                        <button class="btn btn-outline-warning w-100 mb-2" onclick="generateClassReport()">
                            <i class="fas fa-file-chart-line me-2"></i>
                            Generate Class Report
                        </button>
                        
                        <button class="btn btn-outline-info w-100 mb-2" onclick="scheduleMeeting()">
                            <i class="fas fa-calendar-alt me-2"></i>
                            Schedule Parent Meeting
                        </button>
                        
                        <button class="btn btn-outline-success w-100" onclick="exportData()">
                            <i class="fas fa-download me-2"></i>
                            Export All Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Student Detail Modal -->
<div class="modal fade" id="studentDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Student Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="studentDetailContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Edit Student Modal -->
<div class="modal fade" id="editStudentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Student Marks</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editStudentForm">
                    <div class="mb-3">
                        <label class="form-label">Student ID</label>
                        <input type="text" class="form-control" id="editStudentId" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Attendance (%)</label>
                        <input type="number" class="form-control" id="editAttendance" min="0" max="100" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Previous Score</label>
                        <input type="number" class="form-control" id="editPreviousScore" min="0" max="100" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStudentChanges()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<style>
    .welcome-header {
        text-align: center;
        padding: 30px 0;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
        border-radius: 20px;
        margin-bottom: 30px;
    }
    
    .attendance-bar {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .progress {
        background-color: var(--dark-border);
        border-radius: 10px;
    }
    
    .avatar {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .insights {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .insight-item {
        display: flex;
        align-items: center;
        padding: 15px;
        background: rgba(99, 102, 241, 0.1);
        border-radius: 10px;
        border-left: 4px solid var(--primary-color);
    }
    
    .quick-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .chart-container {
        height: 350px;
        display: flex;
        flex-direction: column;
    }
    
    .chart-container h6 {
        color: var(--primary-color);
        font-weight: 600;
    }
    
    #classPerformanceChart, #attendanceDistributionChart, #subjectAnalyticsChart {
        flex: 1;
        min-height: 300px;
    }
    
    .table tbody tr:hover {
        background-color: rgba(99, 102, 241, 0.1);
        transform: scale(1.01);
        transition: all 0.2s ease;
    }
    
    .table .btn-group {
        display: flex;
        gap: 5px;
    }
    
    .table .btn-group .btn {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        font-weight: 500;
        text-shadow: none;
        min-width: 40px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-group .btn {
        transition: all 0.2s ease;
        color: #ffffff !important;
        border-color: #6366f1 !important;
        margin: 0 2px;
    }
    
    .btn-group .btn:hover {
        transform: translateY(-2px);
        background-color: #6366f1 !important;
        color: #ffffff !important;
    }
    
    .btn-group .btn.btn-outline-primary {
        color: #6366f1 !important;
        border-color: #6366f1 !important;
    }
    
    .btn-group .btn.btn-outline-primary:hover {
        background-color: #6366f1 !important;
        color: #ffffff !important;
    }
    
    .btn-group .btn.btn-outline-warning {
        color: #f59e0b !important;
        border-color: #f59e0b !important;
    }
    
    .btn-group .btn.btn-outline-warning:hover {
        background-color: #f59e0b !important;
        color: #ffffff !important;
    }
    
    .btn-group .btn.btn-outline-info {
        color: #06b6d4 !important;
        border-color: #06b6d4 !important;
    }
    
    .btn-group .btn.btn-outline-info:hover {
        background-color: #06b6d4 !important;
        color: #ffffff !important;
    }
    
    .table .btn-group .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    /* Pagination Styling */
    .pagination .page-link {
        color: #6366f1;
        border-color: #374151;
        background-color: #1f2937;
        transition: all 0.3s ease;
        border-radius: 8px;
        margin: 0 2px;
        font-weight: 500;
    }
    
    .pagination .page-link:hover {
        background-color: #6366f1;
        border-color: #6366f1;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    
    .pagination .page-item.active .page-link {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        border-color: #6366f1;
        color: white;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }
    
    .pagination .page-item.disabled .page-link {
        color: #6b7280;
        background-color: #374151;
        border-color: #4b5563;
        cursor: not-allowed;
    }
    
    .pagination .page-item:not(.disabled):not(.active) .page-link:focus {
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
        outline: none;
    }
    
    /* Page Size Selector Styling */
    #pageSizeSelect {
        background-color: #1f2937;
        border-color: #374151;
        color: #f9fafb;
        border-radius: 6px;
        transition: all 0.2s ease;
    }
    
    #pageSizeSelect:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
        outline: none;
    }
    
    #pageSizeSelect:hover {
        border-color: #6366f1;
    }
    
    /* Button styling moved to base.html for consistency */
</style>

<script>
    // Render charts
    const classPerformanceData = {{ class_performance | safe }};
    Plotly.newPlot('classPerformanceChart', classPerformanceData.data, classPerformanceData.layout, {responsive: true});
    
    const attendanceDistributionData = {{ attendance_distribution | safe }};
    Plotly.newPlot('attendanceDistributionChart', attendanceDistributionData.data, attendanceDistributionData.layout, {responsive: true});
    
    const subjectAnalyticsData = {{ subject_analytics | safe }};
    Plotly.newPlot('subjectAnalyticsChart', subjectAnalyticsData.data, subjectAnalyticsData.layout, {responsive: true});
    
    // View student details
    function viewStudent(studentId) {
        fetch(`/api/student/${studentId}`)
            .then(response => response.json())
            .then(data => {
                const content = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Personal Information</h6>
                            <p><strong>Full Name:</strong> ${data.Full_Name || 'N/A'}</p>
                            <p><strong>ID:</strong> ${data.student_id}</p>
                            <p><strong>Gender:</strong> ${data.Gender}</p>
                            <p><strong>Age:</strong> ${data.age || 'N/A'}</p>
                            <p><strong>School Type:</strong> ${data.School_Type}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Academic Performance</h6>
                            <p><strong>Attendance:</strong> ${data.Attendance}%</p>
                            <p><strong>Previous Score:</strong> ${data.Previous_Scores}</p>
                            <p><strong>Study Hours:</strong> ${data.Hours_Studied}h</p>
                            <p><strong>Sleep Hours:</strong> ${data.Sleep_Hours}h</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6>Additional Factors</h6>
                        <p><strong>Teacher Feedback:</strong> ${data.Teacher_Feedback}</p>
                        <p><strong>Parental Involvement:</strong> ${data.Parental_Involvement}</p>
                        <p><strong>Access to Resources:</strong> ${data.Access_to_Resources}</p>
                        <p><strong>Extracurricular Activities:</strong> ${data.Extracurricular_Activities}</p>
                        <p><strong>Family Income:</strong> ${data.Family_Income}</p>
                        <p><strong>Parental Education:</strong> ${data.Parental_Education_Level || 'N/A'}</p>
                    </div>
                `;
                document.getElementById('studentDetailContent').innerHTML = content;
                new bootstrap.Modal(document.getElementById('studentDetailModal')).show();
            })
            .catch(error => {
                console.error('Error fetching student data:', error);
                alert('Error loading student details. Please try again.');
            });
    }
    
    // Edit student
    function editStudent(studentId) {
        fetch(`/api/student/${studentId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('editStudentId').value = data.student_id;
                document.getElementById('editAttendance').value = data.Attendance;
                document.getElementById('editPreviousScore').value = data.Previous_Scores;
                new bootstrap.Modal(document.getElementById('editStudentModal')).show();
            });
    }
    
    // Save student changes
    function saveStudentChanges() {
        const studentId = document.getElementById('editStudentId').value;
        const attendance = document.getElementById('editAttendance').value;
        const previousScore = document.getElementById('editPreviousScore').value;
        
        fetch('/api/update_marks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                student_id: studentId,
                attendance: parseInt(attendance),
                previous_scores: parseInt(previousScore)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Student marks updated successfully!');
                location.reload();
            } else {
                alert('Error updating student marks: ' + data.error);
            }
        });
        
        bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
    }
    
    // Generate report
    function generateReport(studentId) {
        // Find student data
        const studentRow = document.querySelector(`tr[data-student-id="${studentId}"]`) || 
                          document.querySelector(`tr:has(td:first-child .badge:contains('${studentId}')`);
        
        if (studentRow) {
            const cells = studentRow.querySelectorAll('td');
            const studentName = cells[1]?.querySelector('.fw-bold')?.textContent || 'Student';
            const attendance = cells[4]?.querySelector('small')?.textContent || 'N/A';
            const previousScore = cells[5]?.textContent || 'N/A';
            const studyHours = cells[6]?.textContent || 'N/A';
            
            const reportContent = `
Student Performance Report
==========================
Student: ${studentName}
ID: ${studentId}
Attendance: ${attendance}
Previous Score: ${previousScore}
Study Hours: ${studyHours}

Report generated on: ${new Date().toLocaleDateString()}
            `;
            
            // Create and download report
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `student_report_${studentId}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        } else {
        alert(`Generating report for student ${studentId}...`);
        }
    }
    
    // Export functions
    function exportToCSV() {
        const table = document.querySelector('table');
        let csv = [];
        const rows = table.querySelectorAll('tr');
        
        for (let i = 0; i < rows.length; i++) {
            let row = [], cols = rows[i].querySelectorAll('td, th');
            for (let j = 0; j < cols.length; j++) {
                let text = cols[j].innerText.replace(/,/g, ';');
                row.push('"' + text + '"');
            }
            csv.push(row.join(','));
        }
        
        const csvContent = csv.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'student_data.csv';
        link.click();
    }
    
    function exportData() {
        // Export all student data as CSV
        const table = document.querySelector('table');
        let csv = [];
        const rows = table.querySelectorAll('tr');
        
        for (let i = 0; i < rows.length; i++) {
            let row = [], cols = rows[i].querySelectorAll('td, th');
            for (let j = 0; j < cols.length; j++) {
                let text = cols[j].innerText.replace(/,/g, ';');
                row.push('"' + text + '"');
            }
            csv.push(row.join(','));
        }
        
        const csvContent = csv.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'class_data.csv';
        link.click();
    }
    
    function sendAnnouncement() {
        const message = prompt('Enter your class announcement:');
        if (message) {
            alert(`Announcement sent to class: "${message}"`);
        }
    }
    
    function generateClassReport() {
        // Use real data from backend instead of calculating from DOM
        const totalStudents = {{ total_students }};
        const avgAttendance = {{ avg_attendance }};
        const avgScore = {{ avg_score }};
        const avgStudyHours = {{ avg_study_hours }};
        
        const reportContent = `
Class Performance Report
========================
Total Students: ${totalStudents}
Average Attendance: ${avgAttendance}%
Average Score: ${avgScore}
Average Study Hours: ${avgStudyHours} hours
Report Date: ${new Date().toLocaleDateString()}

This report was generated automatically from the class dashboard using real dataset.
        `;
        
        const blob = new Blob([reportContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'class_report.txt';
        a.click();
        window.URL.revokeObjectURL(url);
    }
    
    function scheduleMeeting() {
        const date = prompt('Enter meeting date (MM/DD/YYYY):');
        const time = prompt('Enter meeting time (HH:MM):');
        if (date && time) {
            alert(`Parent meeting scheduled for ${date} at ${time}`);
        }
    }
    
    // Page jump functionality
    function goToPage() {
        const pageInput = document.getElementById('pageJumpInput');
        const page = parseInt(pageInput.value);
        const totalPages = {{ total_pages }};
        
        if (page && page >= 1 && page <= totalPages) {
            const currentPerPage = {{ per_page }};
            window.location.href = `{{ url_for('teacher_dashboard') }}?page=${page}&per_page=${currentPerPage}`;
        } else {
            alert(`Please enter a valid page number between 1 and ${totalPages}`);
            pageInput.focus();
        }
    }
    
    // Change page size functionality
    function changePageSize() {
        const pageSizeSelect = document.getElementById('pageSizeSelect');
        const newPageSize = pageSizeSelect.value;
        window.location.href = `{{ url_for('teacher_dashboard') }}?page=1&per_page=${newPageSize}`;
    }
    
    // Enter key support for page jump
    document.addEventListener('DOMContentLoaded', function() {
        const pageInput = document.getElementById('pageJumpInput');
        if (pageInput) {
            pageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    goToPage();
                }
            });
        }
    });
</script>
{% endblock %}


    

    .insight-item {

        display: flex;

        align-items: center;

        padding: 15px;

        background: rgba(99, 102, 241, 0.1);

        border-radius: 10px;

        border-left: 4px solid var(--primary-color);

    }

    

    .quick-actions {

        display: flex;

        flex-direction: column;

        gap: 10px;

    }

    

    .chart-container {

        height: 350px;

        display: flex;

        flex-direction: column;

    }

    

    .chart-container h6 {

        color: var(--primary-color);

        font-weight: 600;

    }

    

    #classPerformanceChart, #attendanceDistributionChart, #subjectAnalyticsChart {

        flex: 1;

        min-height: 300px;

    }

    

    .table tbody tr:hover {

        background-color: rgba(99, 102, 241, 0.1);

        transform: scale(1.01);

        transition: all 0.2s ease;

    }

    
    .table .btn-group {
        display: flex;
        gap: 5px;
    }
    
    .table .btn-group .btn {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        font-weight: 500;
        text-shadow: none;
        min-width: 40px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    

    .btn-group .btn {

        transition: all 0.2s ease;

        color: #ffffff !important;
        border-color: #6366f1 !important;
        margin: 0 2px;
    }

    

    .btn-group .btn:hover {

        transform: translateY(-2px);

        background-color: #6366f1 !important;
        color: #ffffff !important;
    }
    
    .btn-group .btn.btn-outline-primary {
        color: #6366f1 !important;
        border-color: #6366f1 !important;
    }
    
    .btn-group .btn.btn-outline-primary:hover {
        background-color: #6366f1 !important;
        color: #ffffff !important;
    }
    
    .btn-group .btn.btn-outline-warning {
        color: #f59e0b !important;
        border-color: #f59e0b !important;
    }
    
    .btn-group .btn.btn-outline-warning:hover {
        background-color: #f59e0b !important;
        color: #ffffff !important;
    }
    
    .btn-group .btn.btn-outline-info {
        color: #06b6d4 !important;
        border-color: #06b6d4 !important;
    }
    
    .btn-group .btn.btn-outline-info:hover {
        background-color: #06b6d4 !important;
        color: #ffffff !important;
    }
    
    .table .btn-group .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

</style>



<script>

    // Render charts

    const classPerformanceData = {{ class_performance | safe }};

    Plotly.newPlot('classPerformanceChart', classPerformanceData.data, classPerformanceData.layout, {responsive: true});

    

    const attendanceDistributionData = {{ attendance_distribution | safe }};

    Plotly.newPlot('attendanceDistributionChart', attendanceDistributionData.data, attendanceDistributionData.layout, {responsive: true});

    

    const subjectAnalyticsData = {{ subject_analytics | safe }};

    Plotly.newPlot('subjectAnalyticsChart', subjectAnalyticsData.data, subjectAnalyticsData.layout, {responsive: true});

    

    // View student details

    function viewStudent(studentId) {

        fetch(`/api/student/${studentId}`)

            .then(response => response.json())

            .then(data => {

                const content = `

                    <div class="row">

                        <div class="col-md-6">

                            <h6>Personal Information</h6>

                            <p><strong>Full Name:</strong> ${data.Full_Name || 'N/A'}</p>
                            <p><strong>ID:</strong> ${data.student_id}</p>

                            <p><strong>Gender:</strong> ${data.Gender}</p>

                            <p><strong>Age:</strong> ${data.age || 'N/A'}</p>

                            <p><strong>School Type:</strong> ${data.School_Type}</p>

                        </div>

                        <div class="col-md-6">

                            <h6>Academic Performance</h6>

                            <p><strong>Attendance:</strong> ${data.Attendance}%</p>

                            <p><strong>Previous Score:</strong> ${data.Previous_Scores}</p>

                            <p><strong>Study Hours:</strong> ${data.Hours_Studied}h</p>

                            <p><strong>Sleep Hours:</strong> ${data.Sleep_Hours}h</p>

                        </div>

                    </div>

                    <div class="mt-3">

                        <h6>Additional Factors</h6>

                        <p><strong>Teacher Feedback:</strong> ${data.Teacher_Feedback}</p>

                        <p><strong>Parental Involvement:</strong> ${data.Parental_Involvement}</p>

                        <p><strong>Access to Resources:</strong> ${data.Access_to_Resources}</p>

                        <p><strong>Extracurricular Activities:</strong> ${data.Extracurricular_Activities}</p>

                        <p><strong>Family Income:</strong> ${data.Family_Income}</p>
                        <p><strong>Parental Education:</strong> ${data.Parental_Education_Level || 'N/A'}</p>
                    </div>

                `;

                document.getElementById('studentDetailContent').innerHTML = content;

                new bootstrap.Modal(document.getElementById('studentDetailModal')).show();

            })
            .catch(error => {
                console.error('Error fetching student data:', error);
                alert('Error loading student details. Please try again.');
            });

    }

    

    // Edit student

    function editStudent(studentId) {

        fetch(`/api/student/${studentId}`)

            .then(response => response.json())

            .then(data => {

                document.getElementById('editStudentId').value = data.student_id;

                document.getElementById('editAttendance').value = data.Attendance;

                document.getElementById('editPreviousScore').value = data.Previous_Scores;

                new bootstrap.Modal(document.getElementById('editStudentModal')).show();

            });

    }

    

    // Save student changes

    function saveStudentChanges() {

        const studentId = document.getElementById('editStudentId').value;

        const attendance = document.getElementById('editAttendance').value;

        const previousScore = document.getElementById('editPreviousScore').value;

        

        fetch('/api/update_marks', {

            method: 'POST',

            headers: {

                'Content-Type': 'application/json',

            },

            body: JSON.stringify({

                student_id: studentId,

                attendance: parseInt(attendance),

                previous_scores: parseInt(previousScore)

            })

        })

        .then(response => response.json())

        .then(data => {

            if (data.success) {

                alert('Student marks updated successfully!');

                location.reload();

            } else {

                alert('Error updating student marks: ' + data.error);

            }

        });

        

        bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();

    }

    

    // Generate report

    function generateReport(studentId) {

        // Find student data
        const studentRow = document.querySelector(`tr[data-student-id="${studentId}"]`) || 
                          document.querySelector(`tr:has(td:first-child .badge:contains('${studentId}')`);
        
        if (studentRow) {
            const cells = studentRow.querySelectorAll('td');
            const studentName = cells[1]?.querySelector('.fw-bold')?.textContent || 'Student';
            const attendance = cells[4]?.querySelector('small')?.textContent || 'N/A';
            const previousScore = cells[5]?.textContent || 'N/A';
            const studyHours = cells[6]?.textContent || 'N/A';
            
            const reportContent = `
Student Performance Report
==========================
Student: ${studentName}
ID: ${studentId}
Attendance: ${attendance}
Previous Score: ${previousScore}
Study Hours: ${studyHours}

Report generated on: ${new Date().toLocaleDateString()}
            `;
            
            // Create and download report
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `student_report_${studentId}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        } else {
        alert(`Generating report for student ${studentId}...`);

        }
    }

    

    // Export functions

    function exportToCSV() {

        const table = document.querySelector('table');

        let csv = [];

        const rows = table.querySelectorAll('tr');

        

        for (let i = 0; i < rows.length; i++) {

            let row = [], cols = rows[i].querySelectorAll('td, th');

            for (let j = 0; j < cols.length; j++) {

                let text = cols[j].innerText.replace(/,/g, ';');

                row.push('"' + text + '"');

            }

            csv.push(row.join(','));

        }

        

        const csvContent = csv.join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

        const link = document.createElement('a');

        link.href = URL.createObjectURL(blob);

        link.download = 'student_data.csv';

        link.click();

    }

    

    function exportData() {

        // Export all student data as CSV
        const table = document.querySelector('table');
        let csv = [];
        const rows = table.querySelectorAll('tr');
        
        for (let i = 0; i < rows.length; i++) {
            let row = [], cols = rows[i].querySelectorAll('td, th');
            for (let j = 0; j < cols.length; j++) {
                let text = cols[j].innerText.replace(/,/g, ';');
                row.push('"' + text + '"');
            }
            csv.push(row.join(','));
        }
        
        const csvContent = csv.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'class_data.csv';
        link.click();
    }

    

    function sendAnnouncement() {

        const message = prompt('Enter your class announcement:');
        if (message) {
            alert(`Announcement sent to class: "${message}"`);
        }
    }

    

    function generateClassReport() {

        // Use real data from backend instead of calculating from DOM
        const totalStudents = {{ total_students }};
        const avgAttendance = {{ avg_attendance }};
        const avgScore = {{ avg_score }};
        const avgStudyHours = {{ avg_study_hours }};
        
        const reportContent = `
Class Performance Report
========================
Total Students: ${totalStudents}
Average Attendance: ${avgAttendance}%
Average Score: ${avgScore}
Average Study Hours: ${avgStudyHours} hours
Report Date: ${new Date().toLocaleDateString()}

This report was generated automatically from the class dashboard using real dataset.
        `;
        
        const blob = new Blob([reportContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'class_report.txt';
        a.click();
        window.URL.revokeObjectURL(url);
    }

    

    function scheduleMeeting() {

        const date = prompt('Enter meeting date (MM/DD/YYYY):');
        const time = prompt('Enter meeting time (HH:MM):');
        if (date && time) {
            alert(`Parent meeting scheduled for ${date} at ${time}`);
        }
    }

</script>

{% endblock %}


